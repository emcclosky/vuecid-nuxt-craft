"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _lodash = _interopRequireDefault(require("lodash.clonedeep"));

var _vuecidHelpers = require("@wearelucid/vuecid-helpers");

var _flattenNavigation = _interopRequireDefault(require("../navigation/flattenNavigation"));

var _addLanguagePrefixes = _interopRequireDefault(require("../navigation/addLanguagePrefixes"));

var _stripTrailingHomeSlug = _interopRequireDefault(require("../url/stripTrailingHomeSlug"));

/**
 * Generate routes from data
 *
 * Uses a .json file as base to generate routes for nuxt
 * !This JSON file needs to have a certain structure!
 *
 * Special behaviour for home slugs:
 * We use `/` for the default lang home slug, `/en/` for the english home etc.
 *
 * ‚ö†Ô∏è For now we cannot have nested pages within home `/home/my-nested-slug`
 * ü§∑‚Äç Makes sense to be aware of that!
 *
 * @param {Object} options - The options object to pass in
 * @param {string} options.data
 * @param {Array} [options.section] ‚Äì the craft sections that should be the source for our routes
 * @param {string} [options.homeSlug]
 * @param {string} [options.debug]
 * @return {Array} An array of routes to be generated by nuxt generate
 *
 */

/* eslint-disable no-console */
function generateRoutesFromData() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {
    data: {},
    sections: ['pages'],
    homeSlug: 'home',
    defaultLanguage: 'de',
    debug: false
  };

  try {
    var data = options.data,
        sections = options.sections,
        homeSlug = options.homeSlug,
        defaultLanguage = options.defaultLanguage;
    var clonedData = (0, _lodash["default"])(data);

    if (options.debug) {
      console.log('üìá generateRoutesFromData options: ', options);
    } // flatten data to get all nested pages
    // This is normally only needed if you pass in your navigations file,
    // which has nested pages, to be represented in the navigation
    // if your data is on one level only, even better.


    var flattenedData = (0, _flattenNavigation["default"])({
      navigationData: clonedData,
      sections: sections
    }); // add language prefixes like:
    // uri: 'parent-page/nested-page' ==> uri: 'en/parent-page/nested-page'
    // for every language except the default language
    // (we have to do this because on entry level in craft we don't know the language (or the prefix))
    // but for that we need to know the default language

    var prefixedData = (0, _addLanguagePrefixes["default"])({
      data: flattenedData,
      defaultLanguage: defaultLanguage
    });
    console.log('prefixedData: ', prefixedData);
    var routes = []; // go through each language

    Object.keys(prefixedData).map(function (lang) {
      if (!sections) {
        console.error('üëπ GenerateRoutesFromData: You have not provided any sections');
      } else {
        // and through each section
        sections.forEach(function (section) {
          var _routes;

          var entryURIs = prefixedData[lang][section].map(function (entry) {
            return entry.uri;
          });

          (_routes = routes).push.apply(_routes, (0, _toConsumableArray2["default"])(entryURIs));
        });
      }
    }); // Kick out all the pages ending with the home slug
    // this will delete all homes for each language
    // it also means we can't have nested pages in home
    // Sadly this step is necessary since we can not redirect() with our middleware during generate

    routes = routes.filter(function (r) {
      // Removing 'home' or '/home'
      return r !== homeSlug && r !== "/".concat(homeSlug);
    }) // remove slashes and truncate 'de/home' to 'de' etc.
    .map(function (r) {
      return (0, _vuecidHelpers.verifyLeadingSlash)((0, _stripTrailingHomeSlug["default"])((0, _vuecidHelpers.removeTrailingSlash)(r)));
    });

    if (options.debug) {
      console.log('üìá generateRoutesFromData routes', routes);
    }

    return routes;
  } catch (e) {
    console.log('generateRoutesFromData: üóÉ ‚ùå generateRoutesFromData() failed: ', e);
  }
}

var _default = generateRoutesFromData;
exports["default"] = _default;